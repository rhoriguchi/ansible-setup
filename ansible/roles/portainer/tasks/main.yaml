---
- name: Build portainer image
  docker_image:
    name: portainer/portainer
    force: yes

- name: Create portainer data dir
  file:
    path: "{{ portainer_data_path }}"
    state: directory

- name: Create portainer /data dir
  file:
    path: "{{ portainer_data_path }}/data"
    state: directory

# TODO use authentication
#- name: Generate portainer admin password hash
#  shell: "docker run --rm httpd:2.4-alpine htpasswd -nbB admin {{ vault_portainer_password }} | cut -d ':' -f 2"
#  register: portainer_admin_password
#  no_log: true

- name: Delete portainer container
  shell: docker rm --force portainer
  ignore_errors: yes

- name: Create portainer container
  shell: >-
    docker run
    --detach
    --mount src='{{ portainer_data_path }}/data',target=/data,type=bind
    --mount src=/var/run/docker.sock,target=/var/run/docker.sock,type=bind
    --name portainer
    --publish 9000:9000
    --restart unless-stopped
    portainer/portainer  --no-auth
# portainer/portainer --admin-password={{ portainer_admin_password.stdout_lines }}
