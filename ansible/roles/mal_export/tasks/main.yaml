---
# TODO does not build

- name: Generate myanimelist-export.yaml with correct values
  template:
    src: myanimelist-export.yaml.jinja2
    dest: "{{ role_path }}/files/myanimelist-export.yaml"
  delegate_to: localhost

- name: Generate myanimelist-export.sh with correct values
  template:
    src: myanimelist-export.sh.jinja2
    dest: "{{ role_path }}/files/myanimelist-export.sh"
  delegate_to: localhost

- name: Copy docker files to remote host
  copy:
    src: "{{ role_path }}/files/"
    dest: "{{ tmp_docker_dir }}"
    force: yes

- name: Build mal_export image
  docker_image:
    name: rhoriguchi/mal_export
    path: "{{ tmp_docker_dir }}"
    buildargs:
      alpine_version: "{{ alpine_version }}"
      ubuntu_version: "{{ ubuntu_version }}"
    force: yes

- name: Create mal_export exports dir
  file:
    path: "{{ mal_export_path }}"
    state: directory

- name: Create mal_export data dir
  file:
    path: "{{ mal_export_data_path }}"
    state: directory

- name: Delete mal_export container
  shell: "docker rm --force mal_export_{{ vault_mal_username | replace('@', '_at_') }}"
  ignore_errors: yes

- name: Create mal_export container
  shell: >-
    docker run
    --detach
    --env TZ='{{ timezone }}'
    --mount src='{{ mal_export_path }}',target=/export,type=bind,type=bind
    --mount src='{{ mal_export_data_path }}/mal_export.log',target=/mal_export.log,type=bind
    --name mal_export
    --restart unless-stopped
    rhoriguchi/mal_export

- name: Delete docker files from remote host
  file:
    path: "{{ tmp_docker_dir }}"
    state: absent
