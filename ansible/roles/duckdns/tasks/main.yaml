---
- name: Copy docker files to remote host
  copy:
    src: "{{ role_path }}/files/"
    dest: "{{ target_tmp_docker_dir }}"
    force: yes

- name: Build duckdns image
  docker_image:
    name: rhoriguchi/duckdns
    path: "{{ target_tmp_docker_dir }}"
    buildargs:
      duckdns_domain: "{{ duckdns_domain }}"
      duckdns_token: "{{ vault_duckdns_token }}"
      alpine_version: "{{ alpine_version }}"
    force: yes

- name: Create duckdns data dir
  file:
    path: "{{ duckdns_data_path }}"
    state: directory

- name: Create duckdns /duck.log file
  file:
    path: "{{ duckdns_data_path }}/duck.log"
    state: touch

- name: Delete duckdns container
  shell: docker rm --force duckdns
  ignore_errors: yes

- name: Create duckdns container
  shell: >-
    docker run
    --detach
    --mount src='{{ duckdns_data_path }}/duck.log',target=/duckdns/duck.log,type=bind
    --name duckdns
    --restart unless-stopped
    rhoriguchi/duckdns

- name: Delete docker files from remote host
  file:
    path: "{{ target_tmp_docker_dir }}"
    state: absent
